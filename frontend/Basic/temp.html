<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Explorer ‚Äî Updated Styles</title>

  <!-- font awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
  /* ------------------------ Vars & Theme (reimagined) ------------------------ */
  :root{
    --bg-color:#f5f5f5;
    --card-bg:#fff;
    --toolbar-bg:#ffffffcc;
    --text-color:#222;
    --subtext-color:#555;
    --accent-color:#2979ff;
    --muted-accent: rgba(41,121,255,0.12);
    --hover-color:rgba(0,0,0,0.05);
    --border-radius:12px;
    --transition:0.22s ease;
    --toolbar-height:64px;
    --btn-size:40px;
    --card-shadow:0 6px 18px rgba(0,0,0,0.08);
    --card-shadow-hover:0 14px 36px rgba(0,0,0,0.12);
    --content-top-gap:12px;
    --select-bg: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.95));
  }

  body.dark{
    --bg-color:#0d0f12;
    --card-bg:rgba(18,18,18,0.95);
    --toolbar-bg:rgba(14,14,14,0.9);
    --text-color:#e6eef8;
    --subtext-color:#aeb6c2;
    --accent-color:#4ea3ff;
    --muted-accent: rgba(78,163,255,0.08);
    --hover-color:rgba(255,255,255,0.03);
    --card-shadow:0 8px 20px rgba(0,0,0,0.6);
    --card-shadow-hover:0 18px 48px rgba(0,0,0,0.7);
    --select-bg: linear-gradient(180deg, rgba(20,20,20,0.96), rgba(14,14,14,0.98));
  }

  /* ------------------------ Global ------------------------ */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:Inter, "Segoe UI","Roboto",system-ui,-apple-system;
    margin:0;
    background:var(--bg-color);
    color:var(--text-color);
    display:flex;
    flex-direction:column;
    height:100vh;
    transition:background var(--transition),color var(--transition);
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ------------------------ Toolbar ------------------------ */
  .toolbar{
    position:fixed;inset:0 0 auto 0;height:var(--toolbar-height);display:flex;align-items:center;gap:12px;padding:0 20px;background:var(--toolbar-bg);backdrop-filter:blur(8px);border-bottom:1px solid rgba(0,0,0,0.06);z-index:1000;
  }
  .toolbar button{height:var(--btn-size);width:var(--btn-size);border-radius:50%;border:none;background:var(--accent-color);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform var(--transition),box-shadow var(--transition);box-shadow:var(--card-shadow);} 
  .toolbar button:disabled{opacity:.45;cursor:not-allowed}
  .toolbar button:hover:enabled{transform:scale(1.06);box-shadow:var(--card-shadow-hover)}

  /* ------------------------ Custom selects (desktop + mobile) ------------------------ */
  select.styled-select{
    -webkit-appearance:none;appearance:none;border:1px solid rgba(0,0,0,0.08);background:var(--select-bg);padding:8px 36px 8px 12px;border-radius:12px;height:40px;font-size:15px;color:var(--text-color);cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,0.02) inset;min-width:150px;transition:box-shadow var(--transition),border-color var(--transition);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23222" stroke-width="2"><path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    background-repeat:no-repeat;background-position:right 10px center;background-size:18px 18px;
  }
  body.dark select.styled-select{background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23e6eef8" stroke-width="2"><path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>');border:1px solid rgba(255,255,255,0.04)}
  select.styled-select:focus{outline:none;border-color:var(--accent-color);box-shadow:0 6px 20px var(--muted-accent)}

  input[type=search]{height:40px;border-radius:20px;border:1px solid rgba(0,0,0,0.08);background:transparent;padding:0 14px;font-size:16px;color:var(--text-color);flex:1;min-width:0}
  input[type=search]::placeholder{color:var(--subtext-color)}

  /* ------------------------ Loading ------------------------ */
  #loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:700;font-size:18px;color:var(--accent-color);z-index:2000}

  /* ------------------------ File Grid / Cards ------------------------ */
  #fileList{padding: calc(var(--toolbar-height) + var(--content-top-gap)) 20px 88px;flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px}
  .fileItem, .folderItem{background:var(--card-bg);padding:16px;border-radius:12px;display:flex;flex-direction:column;cursor:pointer;transition:transform var(--transition),box-shadow var(--transition);box-shadow:var(--card-shadow);backdrop-filter:blur(6px);position:relative}
  .fileItem:hover, .folderItem:hover{transform:translateY(-4px);box-shadow:var(--card-shadow-hover)}
  .fileIcon{font-size:36px;margin-bottom:12px;text-align:center}
  .fileName{font-weight:600;margin-bottom:8px;word-break:break-word;text-align:center}
  .fileType, .fileModified{font-size:12px;color:var(--subtext-color);text-align:center}
  .fileActions{margin-top:auto;display:flex;justify-content:center;gap:10px}
  .fileActions button{width:36px;height:36px;border-radius:10px;border:none;background:transparent;color:var(--text-color);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:transform var(--transition),background var(--transition)}
  .fileActions button:hover{background:var(--accent-color);color:#fff;transform:scale(1.06)}

  .fileItem.selected, .folderItem.selected{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,0.35)}

  /* ---------------- Path widget ‚Äî changed to bottom full-width bar ---------------- */
  .pathWidget{
    position:fixed;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--toolbar-bg);color:var(--text-color);padding:12px 20px;border-top:1px solid rgba(0,0,0,0.06);z-index:2000;transition:background var(--transition),color var(--transition);box-shadow:0 -6px 18px rgba(0,0,0,0.06);
  }
  .pathLeft{display:flex;align-items:center;gap:12px;min-width:0}
  .pathHandle i{font-size:18px}
  #pathLabel{font-size:14px;color:var(--subtext-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .pathRight{display:flex;align-items:center;gap:8px}
  .pathWidget .iconBtn{background:transparent;border:none;cursor:pointer;color:var(--subtext-color);padding:8px;border-radius:8px}
  .pathWidget .iconBtn:hover{color:var(--accent-color);background:var(--muted-accent)}

  /* ---------------- Mobile behaviour & fixes ---------------- */
  @media (max-width:768px){
    .toolbar{height:56px;padding:8px 12px;gap:8px}
    .desktop-only{display:none !important}
    .mobile-only{display:inline-flex !important}
    #fileList{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));padding-top: calc(var(--toolbar-height) + var(--content-top-gap));}
    .fileIcon{font-size:28px;margin-bottom:8px}
    .fileName{font-size:14px}
    #searchInput{flex:1;min-width:0;height:40px;border-radius:14px}

    /* bigger, clearer sidebar text & controls */
    .mobileSidebar{font-size:16px;padding:18px;}
    .mobileRow{padding:14px 6px}
    .mobileLabel{font-size:15px}
    .mobileControl{min-width:140px;padding:10px 14px;border-radius:12px;font-size:15px}

    /* path bar fixed width adjustments on small screens */
    .pathWidget{padding:12px 14px}
    #pathLabel{max-width:60vw;font-size:13px}
  }

  @media (max-width:420px){
    .mobileSidebar{width:92%}
    .mobileSidebar.open{right:0}
    .mobileSidebar{font-size:15px}
  }

  /* ---------------- Mobile sidebar & utilities (uses variables so dark theme follows) ---------------- */
  .mobileSidebar{position:fixed;top:0;right:-360px;width:320px;max-width:86%;height:100%;background:var(--toolbar-bg);color:var(--text-color);z-index:1600;box-shadow:-12px 0 36px rgba(0,0,0,0.35);backdrop-filter:blur(12px);padding:18px;display:flex;flex-direction:column;gap:12px;transition:right 260ms cubic-bezier(.2,.9,.2,1);border-left:1px solid rgba(0,0,0,0.06);overflow-y:auto}
  .mobileSidebar.open{right:0}
  .mobileSidebarHeader{display:flex;align-items:center;justify-content:space-between;gap:8px;padding-bottom:6px;border-bottom:1px solid rgba(0,0,0,0.04)}
  .mobileRow{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 4px;border-radius:10px}
  .mobileLabel{font-size:13px;color:var(--subtext-color)}
  .mobileControl{min-width:120px;padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
  .sidebarBackdrop{position:fixed;inset:0;background:rgba(0,0,0,0.18);backdrop-filter:blur(4px);z-index:1550;opacity:0;transition:opacity 180ms ease;pointer-events:none}
  .sidebarBackdrop.show{opacity:1;pointer-events:auto}
  body.sidebar-open #fileList, body.sidebar-open .toolbar, body.sidebar-open .pathWidget{filter:blur(2px) brightness(0.92)}

  /* small helpers */
  .iconBtn{background:transparent;border:none;cursor:pointer;color:var(--subtext-color)}
  .errorMessage{padding:18px;background:var(--card-bg);border-radius:10px;color:var(--subtext-color);text-align:center}
  </style>
</head>
<body>

  <!-- Toolbar (fixed top) -->
  <header class="toolbar" role="banner" aria-label="Toolbar">
    <button id="backBtn" class="toolbarBtn hide-when-sidebar-open" disabled title="Go back" aria-label="Go back">
      <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
    </button>

    <button id="forwardBtn" class="toolbarBtn hide-when-sidebar-open" disabled title="Go forward" aria-label="Go forward">
      <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
    </button>

    <!-- Desktop sorting (hidden on narrow screens) -->
    <select id="sortSelect" class="desktop-only styled-select" title="Sort files/folders" aria-label="Sort files">
      <option value="name_asc">Name ASC</option>
      <option value="name_desc">Name DESC</option>
      <option value="modified_desc">Modified DESC</option>
      <option value="modified_asc">Modified ASC</option>
      <option value="size_desc">Size DESC</option>
      <option value="size_asc">Size ASC</option>
    </select>

    <!-- Search input (collapses when sidebar open) -->
    <input id="searchInput" type="search" placeholder="Search files / folders" class="hide-when-sidebar-open" aria-label="Search files" />

    <!-- Theme toggle (desktop) -->
    <button id="themeToggle" class="desktop-only" aria-label="Toggle theme" title="Toggle theme">
      <i class="fa-solid fa-sun" aria-hidden="true"></i>
    </button>

    <!-- mobile burger menu (visible on small screens) -->
    <button id="burgerBtn" class="mobile-only" aria-label="Open menu" title="Menu">
      <i class="fa-solid fa-bars" aria-hidden="true"></i>
    </button>
  </header>

  <!-- Loading/status element -->
  <div id="loading" aria-live="polite" role="status"></div>

  <!-- Main file grid (files/folders rendered here by script) -->
  <main id="fileList" role="list" aria-label="Files and folders"></main>

  <!-- Bottom path bar (full width) -->
  <div id="pathWidget" class="pathWidget" role="region" aria-label="Current directory">
    <div class="pathLeft">
      <div class="pathHandle" title="Current folder">
        <i class="fa-solid fa-folder" aria-hidden="true"></i>
        <span id="pathLabel" aria-live="polite">/</span>
      </div>
    </div>
    <div class="pathRight">
      <button id="openFolderInfo" class="iconBtn" aria-label="Folder details" title="Folder details"><i class="fa-solid fa-info-circle" aria-hidden="true"></i></button>
    </div>
  </div>

  <!-- Mobile/small-screen sidebar (slides from right) -->
  <aside id="mobileSidebar" class="mobileSidebar" role="dialog" aria-label="Options" aria-hidden="true">
    <div class="mobileSidebarHeader" role="toolbar" aria-label="Sidebar actions">
      <strong>Actions</strong>
      <button id="sidebarCloseBtn" class="iconBtn" aria-label="Close"><i class="fa-solid fa-xmark" aria-hidden="true"></i></button>
    </div>

    <div class="mobileSidebarContent">
      <div class="mobileRow">
        <label class="mobileLabel">Theme</label>
        <button id="themeToggleMobile" class="mobileControl" aria-label="Toggle theme (mobile)">
          <i class="fa-solid fa-sun" aria-hidden="true"></i> Toggle
        </button>
      </div>

      <div class="mobileRow">
        <label class="mobileLabel">Sort</label>
        <select id="sortSelectMobile" class="mobileControl styled-select" aria-label="Sort files (mobile)">
          <option value="name_asc">Name ASC</option>
          <option value="name_desc">Name DESC</option>
          <option value="modified_desc">Modified DESC</option>
          <option value="modified_asc">Modified ASC</option>
          <option value="size_desc">Size DESC</option>
          <option value="size_asc">Size ASC</option>
        </select>
      </div>

      <!-- Add more mobile-only controls here if needed -->
    </div>
  </aside>

  <!-- Backdrop shown when sidebar/modal open -->
  <div id="sidebarBackdrop" class="sidebarBackdrop" aria-hidden="true"></div>

  <!-- socket.io and app script -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
  (() => {
    'use strict';

    const HOST = "localhost";
    const PORT = 8888;
    const BASE_URL = `http://${HOST}:${PORT}`;
    const socket = io(BASE_URL);

    const fileListDiv = document.getElementById('fileList');
    const loadingDiv = document.getElementById('loading');
    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const themeToggle = document.getElementById('themeToggle');

    const burgerBtn = document.getElementById('burgerBtn');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
    const sortSelectMobile = document.getElementById('sortSelectMobile');
    const themeToggleMobile = document.getElementById('themeToggleMobile');

    const pathWidget = document.getElementById('pathWidget');
    const pathLabel = document.getElementById('pathLabel');
    const openFolderInfo = document.getElementById('openFolderInfo');

    let currentPath = '/';
    let backStack = [];
    let forwardStack = [];
    let currentFiles = [];
    let currentFolderDetails = null;
    let selectedItems = new Set();

    const mediaExtensions = { image: ['.jpg','.jpeg','.png','.gif','.bmp','.webp'], audio: ['.mp3','.wav','.ogg','.m4a'], video: ['.mp4','.webm','.ogv','.mov','.mkv'] };
    const safeText = (v, fallback = '') => (typeof v === 'string' && v.trim().length > 0) ? v : fallback;

    function isStreamable(ext) { ext = ext?.toLowerCase() || ''; return mediaExtensions.image.includes(ext) || mediaExtensions.audio.includes(ext) || mediaExtensions.video.includes(ext); }
    function formatDate(dtStr) { if(!dtStr) return ''; const dt = new Date(dtStr); return dt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' ' + dt.toLocaleDateString(); }
    function formatSize(bytes){ if (!bytes && bytes !== 0) return ""; if (!bytes || bytes === 0) return "0 B"; const units=["B","KB","MB","GB","TB"]; const i=Math.floor(Math.log(bytes)/Math.log(1024)); return (bytes/Math.pow(1024,i)).toFixed(1)+" "+units[i]; }
    function getFileIcon(ext,type){ if(type==='directory') return 'üìÅ'; ext = ext?.toLowerCase() || ''; if(mediaExtensions.video.includes(ext)) return 'üé¨'; if(mediaExtensions.audio.includes(ext)) return 'üéµ'; if(mediaExtensions.image.includes(ext)) return 'üñºÔ∏è'; return 'üìÑ'; }
    function updateNavButtons(){ if(backBtn) backBtn.disabled = backStack.length <= 0; if(forwardBtn) forwardBtn.disabled = forwardStack.length <= 0; }

    function openSidebar(){ if(!mobileSidebar || !sidebarBackdrop) return; mobileSidebar.classList.add('open'); sidebarBackdrop.classList.add('show'); document.body.classList.add('sidebar-open'); try{ document.documentElement.style.overflow='hidden'; }catch(e){} if (burgerBtn){ const i=burgerBtn.querySelector('i'); if(i){ i.classList.remove('fa-bars'); i.classList.add('fa-xmark'); } } }
    function closeSidebar(){ if(!mobileSidebar || !sidebarBackdrop) return; mobileSidebar.classList.remove('open'); sidebarBackdrop.classList.remove('show'); document.body.classList.remove('sidebar-open'); try{ document.documentElement.style.overflow=''; }catch(e){} if (burgerBtn){ const i=burgerBtn.querySelector('i'); if(i){ i.classList.remove('fa-xmark'); i.classList.add('fa-bars'); } } }
    function toggleSidebar(){ if(!mobileSidebar) return; mobileSidebar.classList.contains('open') ? closeSidebar() : openSidebar(); }

    if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', closeSidebar);
    if (sidebarCloseBtn) sidebarCloseBtn.addEventListener('click', closeSidebar);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeSidebar(); closeModal(); } });
    if (burgerBtn) burgerBtn.addEventListener('click', toggleSidebar);

    function toggleThemeUi(){ document.body.classList.toggle('dark'); const t = themeToggle && themeToggle.querySelector('i'); const t2 = themeToggleMobile && themeToggleMobile.querySelector('i'); [t,t2].forEach(icon => { if(!icon) return; icon.classList.toggle('fa-sun'); icon.classList.toggle('fa-moon'); }); }
    if (themeToggle) themeToggle.addEventListener('click', toggleThemeUi);
    if (themeToggleMobile) themeToggleMobile.addEventListener('click', toggleThemeUi);

    if (sortSelect && sortSelectMobile) {
      sortSelectMobile.value = sortSelect.value;
      sortSelect.addEventListener('change', () => { sortSelectMobile.value = sortSelect.value; if (currentFiles.length > 0) renderFileList(currentFiles); });
      sortSelectMobile.addEventListener('change', () => { sortSelect.value = sortSelectMobile.value; if (currentFiles.length > 0) renderFileList(currentFiles); });
    }

    function requestPath(path, pushHistory=true){ currentPath = path || '/'; if (pathLabel) pathLabel.textContent = safeText(path, '/'); fileListDiv && (fileListDiv.innerHTML = ''); loadingDiv && (loadingDiv.textContent = 'Loading...'); socket.emit('list_dir', { path: currentPath }); if(pushHistory){ if(backStack.length === 0 || backStack[backStack.length-1] !== currentPath) backStack.push(currentPath); forwardStack = []; updateNavButtons(); } if (mobileSidebar && mobileSidebar.classList.contains('open')) closeSidebar(); clearSelections(); }

    if (backBtn) backBtn.onclick = () => { if(backStack.length > 1){ forwardStack.push(backStack.pop()); requestPath(backStack[backStack.length-1], false); updateNavButtons(); } };
    if (forwardBtn) forwardBtn.onclick = () => { if(forwardStack.length > 0){ const nextPath = forwardStack.pop(); requestPath(nextPath, false); backStack.push(nextPath); updateNavButtons(); } };

    if (searchInput) { searchInput.addEventListener('input', () => { const search = searchInput.value.toLowerCase(); document.querySelectorAll('.fileItem, .folderItem').forEach(el => { const name = (el.dataset.name || "").toLowerCase(); el.style.display = name.includes(search) ? 'flex' : 'none'; }); }, { passive: true }); }

    function sortFiles(files){ const criteria = (sortSelect && sortSelect.value) || (sortSelectMobile && sortSelectMobile.value) || 'name_asc'; return files.slice().sort((a,b) => { switch(criteria){ case 'name_asc': return a.details.name.localeCompare(b.details.name); case 'name_desc': return b.details.name.localeCompare(a.details.name); case 'modified_asc': return new Date(a.details.modified) - new Date(b.details.modified); case 'modified_desc': return new Date(b.details.modified) - new Date(a.details.modified); case 'size_asc': return (a.details.size||0) - (b.details.size||0); case 'size_desc': return (b.details.size||0) - (a.details.size||0); default: return 0; } }); }

    function clearSelections(){ selectedItems.forEach(el => el.classList.remove('selected')); selectedItems.clear(); updateFolderActionButtons(); }
    function selectElement(itemDiv){ selectedItems.forEach(el => el.classList.remove('selected')); selectedItems.clear(); itemDiv.classList.add('selected'); selectedItems.add(itemDiv); updateFolderActionButtons(); }
    function toggleSelectElement(itemDiv){ if (itemDiv.classList.contains('selected')) { itemDiv.classList.remove('selected'); selectedItems.delete(itemDiv); } else { selectedItems.forEach(el => el.classList.remove('selected')); selectedItems.clear(); itemDiv.classList.add('selected'); selectedItems.add(itemDiv); } updateFolderActionButtons(); }

    function updateFolderActionButtons(){ document.querySelectorAll('.folderItem').forEach(folderEl => { const actions = folderEl.querySelector('.fileActions'); if(!actions) return; actions.style.display = folderEl.classList.contains('selected') ? 'flex' : 'none'; }); }

    document.addEventListener('click', (e) => {
      const isFileCard = !!e.target.closest('.fileItem, .folderItem');
      const isWidget = !!e.target.closest('#pathWidget');
      const isToolbar = !!e.target.closest('.toolbar');
      const isSidebar = !!e.target.closest('#mobileSidebar');
      const isModal = !!e.target.closest('#folderModal') || !!e.target.closest('.modal-backdrop');
      if(!isFileCard && !isWidget && !isToolbar && !isSidebar && !isModal) clearSelections();
    });

    function fetchDirOnce(path, timeout = 10000){ return new Promise((resolve, reject) => { let resolved = false; const handler = (res) => { if(!res || !res.data) return; if(res.data.path === path){ resolved = true; socket.off('list_dir_result', handler); clearTimeout(to); resolve(res); } }; socket.on('list_dir_result', handler); socket.emit('list_dir', { path }); const to = setTimeout(() => { if(!resolved){ socket.off('list_dir_result', handler); reject(new Error('Timeout fetching directory listing for ' + path)); } }, timeout); }); }

    async function downloadFilesInDir(path){ try { if (loadingDiv) loadingDiv.textContent = 'Fetching folder contents...'; const res = await fetchDirOnce(path, 15000); if (loadingDiv) loadingDiv.textContent = ''; if(!res || res.status === 'error' || !res.data || !Array.isArray(res.data.children)){ alert('Could not fetch folder contents.'); return; } const children = res.data.children; const files = children.filter(c => c.type === 'file'); if(files.length === 0){ alert('No files to download (folders are skipped).'); return; } files.forEach(f => { const url = `${BASE_URL}/download/file?path=${encodeURIComponent(f.path)}`; const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.download = f.details && f.details.name ? f.details.name : ''; document.body.appendChild(a); a.click(); a.remove(); }); } catch(err) { if (loadingDiv) loadingDiv.textContent = ''; console.error(err); alert('Failed to download folder files: ' + (err.message || err)); } }

    function attachItemHandlers(itemDiv, item){ itemDiv.dataset.path = item.path; itemDiv.dataset.type = item.type; itemDiv.dataset.name = item.details.name || ''; let touchTimer = null; let clickTimeout = null; itemDiv.addEventListener('click', (evt) => { if (evt.target.closest('.fileActions')) return; if(item.type === 'directory'){ if(clickTimeout) clearTimeout(clickTimeout); clickTimeout = setTimeout(() => { requestPath(item.path); }, 240); } else if(item.type === 'file'){ if(clickTimeout) clearTimeout(clickTimeout); clickTimeout = setTimeout(() => { if(isStreamable(item.details.extension)) streamFile(item); else window.open(`${BASE_URL}/download/file?path=${encodeURIComponent(item.path)}`, '_blank'); }, 240); } }); itemDiv.addEventListener('dblclick', (e) => { e.stopPropagation(); if (clickTimeout) { clearTimeout(clickTimeout); clickTimeout = null; } toggleSelectElement(itemDiv); }); itemDiv.addEventListener('touchstart', (e) => { if(touchTimer) clearTimeout(touchTimer); touchTimer = setTimeout(() => toggleSelectElement(itemDiv), 500); }, { passive: true }); itemDiv.addEventListener('touchend', (e) => { if(touchTimer) { clearTimeout(touchTimer); touchTimer = null; } }); itemDiv.setAttribute('tabindex', '0'); itemDiv.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ if(item.type === 'directory') requestPath(item.path); else { if(isStreamable(item.details.extension)) streamFile(item); else window.open(`${BASE_URL}/download/file?path=${encodeURIComponent(item.path)}`, '_blank'); } } else if(e.key === ' ' || e.key === 'Spacebar'){ e.preventDefault(); toggleSelectElement(itemDiv); } }); }

    function renderFileList(files){ if(!fileListDiv) return; fileListDiv.innerHTML = ''; const sorted = sortFiles(files); sorted.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = item.type === 'directory' ? 'folderItem' : 'fileItem'; itemDiv.dataset.name = item.details.name || ''; itemDiv.dataset.modified = item.details.modified || ''; itemDiv.dataset.size = item.details.size || 0; const iconDiv = document.createElement('div'); iconDiv.className = "fileIcon"; iconDiv.textContent = getFileIcon(item.details.extension, item.type); itemDiv.appendChild(iconDiv); const nameDiv = document.createElement('div'); nameDiv.className = 'fileName'; nameDiv.textContent = item.details.name || ''; itemDiv.appendChild(nameDiv); const typeDiv = document.createElement('div'); typeDiv.className = 'fileType'; typeDiv.textContent = item.type === 'directory' ? `${item.details.count || 0} items` : formatSize(item.details.size || 0); itemDiv.appendChild(typeDiv); const modifiedDiv = document.createElement('div'); modifiedDiv.className = 'fileModified'; modifiedDiv.textContent = formatDate(item.details.modified); itemDiv.appendChild(modifiedDiv); const actionsDiv = document.createElement('div'); actionsDiv.className = 'fileActions'; actionsDiv.style.display = (item.type === 'directory') ? 'none' : 'flex'; if(item.type === 'directory') { const downloadBtn = document.createElement('button'); downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i>'; downloadBtn.title = "Download files in this folder (skip subfolders)"; downloadBtn.addEventListener('click', (e) => { e.stopPropagation(); downloadFilesInDir(item.path); }); actionsDiv.appendChild(downloadBtn); } else { const downloadBtn = document.createElement('button'); downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i>'; downloadBtn.title = "Download this file"; downloadBtn.addEventListener('click', (e) => { e.stopPropagation(); window.open(`${BASE_URL}/download/file?path=${encodeURIComponent(item.path)}`, '_blank'); }); actionsDiv.appendChild(downloadBtn); if(isStreamable(item.details.extension)){ const streamBtn = document.createElement('button'); streamBtn.innerHTML = '<i class="fa-solid fa-play"></i>'; streamBtn.title = "Stream this file"; streamBtn.addEventListener('click', (e) => { e.stopPropagation(); streamFile(item); }); actionsDiv.appendChild(streamBtn); } }
      itemDiv.appendChild(actionsDiv);
      attachItemHandlers(itemDiv, item);
      fileListDiv.appendChild(itemDiv);
    });

      updateNavButtons();
      updateFolderActionButtons();
    }

    function streamFile(item){ const url = `${BASE_URL}/download/file?path=${encodeURIComponent(item.path)}`; const ext = (item.details.extension || '').toLowerCase(); if(mediaExtensions.image.includes(ext)){ const imgWindow = window.open('', '_blank'); const img = imgWindow.document.createElement('img'); img.src = url; img.style.maxWidth = '100%'; img.style.height = 'auto'; imgWindow.document.body.appendChild(img); } else if(mediaExtensions.audio.includes(ext)){ const audioWindow = window.open('', '_blank'); const audio = audioWindow.document.createElement('audio'); audio.controls = true; audio.autoplay = true; audio.style.width='100%'; const source = audioWindow.document.createElement('source'); source.src = `${BASE_URL}/stream/file?path=${encodeURIComponent(item.path)}`; source.type = item.details.filetype || 'audio/mpeg'; audio.appendChild(source); audioWindow.document.body.appendChild(audio); } else if(mediaExtensions.video.includes(ext)){ const videoWindow = window.open('', '_blank'); const video = videoWindow.document.createElement('video'); video.id='player'; video.className='video-js vjs-big-play-centered'; video.controls=true; video.preload='auto'; video.width=videoWindow.innerWidth; video.height=videoWindow.innerHeight; const source = videoWindow.document.createElement('source'); source.src = `${BASE_URL}/stream/file?path=${encodeURIComponent(item.path)}`; source.type = 'video/mp4'; video.appendChild(source); videoWindow.document.body.appendChild(video); const link = videoWindow.document.createElement('link'); link.rel='stylesheet'; link.href='https://vjs.zencdn.net/8.13.0/video-js.css'; videoWindow.document.head.appendChild(link); const script = videoWindow.document.createElement('script'); script.src='https://vjs.zencdn.net/8.13.0/video.min.js'; script.onload = ()=>{ if(videoWindow.videojs) videoWindow.videojs('player').ready(()=>videoWindow.videojs('player').requestFullscreen()); }; videoWindow.document.body.appendChild(script); } }

    socket.on('list_dir_status', (data) => { if(data && data.status === 'loading') { if (loadingDiv) loadingDiv.textContent = 'Loading ' + (data.path || '') + '...'; } });

    if (pathLabel) { if (!pathLabel.textContent || !pathLabel.textContent.trim()) pathLabel.textContent = '/'; pathLabel.style.display = pathLabel.style.display || 'inline-block'; }

    socket.on('list_dir_result', (res) => {
      try {
        if (loadingDiv) loadingDiv.textContent = '';
        if (!res || !res.data) return;
        const serverPath = (typeof res.data.path === 'string' && res.data.path.trim().length > 0) ? res.data.path : '/';
        if (pathLabel) { pathLabel.textContent = serverPath; }
        if(res.status === 'error'){
          if (fileListDiv) fileListDiv.innerHTML = `<div class=\"errorMessage\">Error ${res.code}: ${res.message}</div>`;
          return;
        }
        currentFolderDetails = res.data && res.data.details ? res.data.details : currentFolderDetails;
        if(res.data && res.data.path === currentPath){ currentFiles = res.data.children || []; if(currentFiles.length === 0){ if (fileListDiv) fileListDiv.innerHTML = '<div class="errorMessage">No files or folders</div>'; return; } renderFileList(currentFiles); }
      } catch(err) { console.error('Error handling list_dir_result', err); }
    });

    /* -------------------- Path widget modal (unchanged behaviour) -------------------- */
    let folderModalEl = null; let modalBackdrop = null;
    function createModalElements(){ if(folderModalEl) return folderModalEl; modalBackdrop = document.createElement('div'); modalBackdrop.className = 'modal-backdrop'; modalBackdrop.style.position = 'fixed'; modalBackdrop.style.inset = '0'; modalBackdrop.style.background = 'rgba(0,0,0,0.35)'; modalBackdrop.style.zIndex = 9998; modalBackdrop.style.display = 'none'; modalBackdrop.addEventListener('click', closeModal); document.body.appendChild(modalBackdrop); folderModalEl = document.createElement('div'); folderModalEl.id = 'folderModal'; folderModalEl.style.position = 'fixed'; folderModalEl.style.top = '50%'; folderModalEl.style.left = '50%'; folderModalEl.style.transform = 'translate(-50%,-50%)'; folderModalEl.style.backgroundColor = 'var(--card-bg, #fff)'; folderModalEl.style.color = 'var(--text-color, #222)'; folderModalEl.style.padding = '18px'; folderModalEl.style.borderRadius = '12px'; folderModalEl.style.boxShadow = '0 12px 36px rgba(0,0,0,0.35)'; folderModalEl.style.zIndex = 9999; folderModalEl.style.maxWidth = '420px'; folderModalEl.style.minWidth = '260px'; folderModalEl.style.display = 'none'; const content = document.createElement('div'); content.className = 'folderModalContent'; folderModalEl.appendChild(content); const closeRow = document.createElement('div'); closeRow.style.display = 'flex'; closeRow.style.justifyContent = 'flex-end'; closeRow.style.marginTop = '12px'; const closeBtn = document.createElement('button'); closeBtn.className = 'iconBtn'; closeBtn.textContent = 'Close'; closeBtn.style.padding = '8px 12px'; closeBtn.addEventListener('click', closeModal); closeRow.appendChild(closeBtn); folderModalEl.appendChild(closeRow); document.body.appendChild(folderModalEl); return folderModalEl; }

    function showFolderModal(details){ if(!details) return; createModalElements(); const content = folderModalEl.querySelector('.folderModalContent'); content.innerHTML = ''; const title = document.createElement('h3'); title.textContent = 'Folder Info'; title.style.margin = '0 0 8px 0'; content.appendChild(title); const fields = [ ['Name', details.name], ['Items', details.count], ['Created', details.created ? formatDate(details.created) : ''], ['Modified', details.modified ? formatDate(details.modified) : ''], ['Accessed', details.accessed ? formatDate(details.accessed) : ''], ['Permissions', details.permissions || ''] ]; fields.forEach(([k,v]) => { const p = document.createElement('p'); p.style.margin = '6px 0'; p.innerHTML = `<strong>${k}:</strong> ${v ?? ''}`; content.appendChild(p); }); const quickRow = document.createElement('div'); quickRow.style.display = 'flex'; quickRow.style.justifyContent = 'flex-end'; quickRow.style.marginTop = '8px'; const quickDownloadBtn = document.createElement('button'); quickDownloadBtn.textContent = 'Download files'; quickDownloadBtn.style.padding = '8px 12px'; quickDownloadBtn.style.marginLeft = '8px'; quickDownloadBtn.addEventListener('click', () => { downloadFilesInDir(currentPath); closeModal(); }); quickRow.appendChild(quickDownloadBtn); content.appendChild(quickRow); modalBackdrop.style.display = 'block'; folderModalEl.style.display = 'block'; }
    function closeModal(){ if(folderModalEl) folderModalEl.style.display = 'none'; if(modalBackdrop) modalBackdrop.style.display = 'none'; }

    if (pathWidget) { pathWidget.addEventListener('click', (e) => { e.stopPropagation(); if(currentFolderDetails) showFolderModal(currentFolderDetails); }); }
    if (openFolderInfo) { openFolderInfo.addEventListener('click', (e)=>{ e.stopPropagation(); if(currentFolderDetails) showFolderModal(currentFolderDetails); }); }

    // Init
    if (pathLabel && (!pathLabel.textContent || !pathLabel.textContent.trim())) pathLabel.textContent = '/';
    requestPath('/');

    window._fileExplorer = { requestPath, fetchDirOnce, downloadFilesInDir, currentFiles };

  })();
  </script>
</body>
</html>
